
<html>
<head>
    <title>Video Mode Buffer Format Tests</title>

<script type="text/javascript">

var canvas    = null;
var ctx       = null;
var canvas2   = null; // for loading foreground sprite
var ctx2      = null;
var imageData = null;
var data      = null;
var buf       = null;
var buf8      = null;
var pixelData = null;

var canvasWidth  = 960;
var canvasHeight = 540;

var foreW = 0;  // Width/Height of front sprite.
var foreH = 0;
var xpos = 20;  // Position of front sprite.
var ypos = 20;

var renderModeB   = 0;  // Background buffer format
var renderModeF   = 0;  // Foreground buffer format

var srcDataB  = new Array();
var srcDataF  = new Array();

function init() 
{
    canvas = document.getElementById("myCanvas");
    ctx    = canvas.getContext('2d');

    canvas2 = document.getElementById("loadCanvas");
    ctx2    = canvas.getContext('2d');

    imageData = ctx.getImageData(0, 0, canvasWidth, canvasHeight);
    data = imageData.data;
    buf  = new ArrayBuffer(imageData.data.length);
    buf8 = new Uint8ClampedArray(buf);
    pixelData = new Uint32Array(buf);

    document.getElementById('file-inputb').addEventListener('change', readSingleFileB, false);
    document.getElementById('file-inputf').addEventListener('change', readSingleFileF, false);

    requestAnimationFrame(render);
}

function RGB888toRGB565(col)
{
    return({
        r: (col.r * 249 + 1014) >> 11,
        g: (col.g * 253 + 505) >> 10,
        b: (col.b * 249 + 1014) >> 11
        });
}

function RGB565toRGB888(col)
{
    return({
        r: (col.r * 527 + 23) >> 6,
        g: (col.g * 259 + 33) >> 6,
        b: (col.b * 527 + 23) >> 6
    });
}

function RGB888toRGB555(col)
{
    return({
        r: (col.r >> 3) & 0x1f,
        g: (col.g >> 3) & 0x1f,
        b: (col.b >> 3) & 0x1f
        });
}

function RGB555toRGB888(col)
{
    return({
        r: (col.r << 3),
        g: (col.g << 3),
        b: (col.b << 3)
    });
}

function RGBA8888toRGBA4444(col)
{
    return({
        r: (col.r >> 4) & 0xf,
        g: (col.g >> 4) & 0xf,
        b: (col.b >> 4) & 0xf,
        a: (col.a >> 4) & 0xf
        });
}

function RGBA4444toRGBA8888(col)
{
    return({
        r: (col.r << 4),
        g: (col.g << 4),
        b: (col.b << 4),
        a: (col.a << 4)
    });
}

var ordered = [
    [ 0,  8,  2, 10 ],
    [ 12, 4, 14,  6 ],
    [ 3, 11,  1,  9 ],
    [ 15, 7, 13,  5 ]
];

function render()
{

    // Render background
    if(renderModeB == 0)
    {
        for (var y = 0; y < canvasHeight; ++y) 
        {
            for (var x = 0; x < canvasWidth; ++x) 
            {
                pixelData[x+(y*canvasWidth)] = srcDataB[x+(y*canvasWidth)];
            }
        }
    }
    else if(renderModeB == 1)
    {
        for (var y = 0; y < canvasHeight; ++y) 
        {
            for (var x = 0; x < canvasWidth; ++x) 
            {
                var pixelR = (srcDataB[x+(y*canvasWidth)] >> 16) & 0xff;
                var pixelG = (srcDataB[x+(y*canvasWidth)] >> 8) & 0xff;
                var pixelB = (srcDataB[x+(y*canvasWidth)] >> 0) & 0xff;
                var pixelRGB565 = RGB888toRGB565({ r: pixelR, g: pixelG, b: pixelB } );
                var pixelRGB888 = RGB565toRGB888(pixelRGB565);
                pixelData[x+(y*canvasWidth)] = (0xff << 24) | (pixelRGB888.r << 16) | (pixelRGB888.g << 8) | pixelRGB888.b;
            }
        }
    }
    else if(renderModeB == 2)
    {
        for (var y = 0; y < canvasHeight; ++y) 
        {
            for (var x = 0; x < canvasWidth; ++x) 
            {
                var pixelR = (srcDataB[x+(y*canvasWidth)] >> 16) & 0xff;
                var pixelG = (srcDataB[x+(y*canvasWidth)] >> 8) & 0xff;
                var pixelB = (srcDataB[x+(y*canvasWidth)] >> 0) & 0xff;
                var pixelRGB565 = RGB888toRGB555({ r: pixelR, g: pixelG, b: pixelB } );
                var pixelRGB888 = RGB555toRGB888(pixelRGB565);
                pixelData[x+(y*canvasWidth)] = (0xff << 24) | (pixelRGB888.r << 16) | (pixelRGB888.g << 8) | pixelRGB888.b;
            }
        }
    }
    else if(renderModeB == 3)
    {
        for (var y = 0; y < canvasHeight; ++y) 
        {
            for (var x = 0; x < canvasWidth; ++x) 
            {
                var o = ordered[x & 3][y & 3];
                var pixelA = (srcDataB[x+(y*canvasWidth)] >> 24) & 0xff;
                pixelA = pixelA - (pixelA >> 4) + o;
                var pixelR = (srcDataB[x+(y*canvasWidth)] >> 16) & 0xff;
                pixelR = pixelR - (pixelR >> 4) + o;
                var pixelG = (srcDataB[x+(y*canvasWidth)] >> 8) & 0xff;
                pixelG = pixelG - (pixelG >> 4) + o;
                var pixelB = (srcDataB[x+(y*canvasWidth)] >> 0) & 0xff;
                pixelB = pixelB - (pixelB >> 4) + o;
                var pixelRGBA4444 = RGBA8888toRGBA4444({ r: pixelR + o, g: pixelG + o, b: pixelB + o, a:pixelA + o } );
                var pixelRGBA8888 = RGBA4444toRGBA8888(pixelRGBA4444);
                pixelData[x+(y*canvasWidth)] = (0xff << 24) | (pixelRGBA8888.r << 16) | (pixelRGBA8888.g << 8) | pixelRGBA8888.b;
            }
        }
    }

    // Render foreground
    if(renderModeF == 0)
    {
        var iy = 0;
        for (var y = ypos; y < ypos+foreH; ++y) 
        {
            var ix = 0;
            for (var x = xpos; x < xpos+foreW; ++x) 
            {
                if(x>=0 && x < canvasWidth && y >=0 && y < canvasHeight)
                {
                    var srcA = (srcDataF[ix+(iy*foreW)] >> 24) & 0xff;
                    var srcR = (srcDataF[ix+(iy*foreW)] >> 16) & 0xff;
                    var srcG = (srcDataF[ix+(iy*foreW)] >> 8) & 0xff;
                    var srcB = (srcDataF[ix+(iy*foreW)] >> 0) & 0xff;
                    var dstR = (pixelData[x+(y*canvasWidth)] >> 16) & 0xff;
                    var dstG = (pixelData[x+(y*canvasWidth)] >> 8) & 0xff;
                    var dstB = (pixelData[x+(y*canvasWidth)] >> 0) & 0xff;
                    srcR = (srcR * (srcA/255.0))|0;
                    srcG = (srcG * (srcA/255.0))|0;
                    srcB = (srcB * (srcA/255.0))|0;
                    dstR = (dstR * (1-(srcA/255.0)))|0;
                    dstG = (dstG * (1-(srcA/255.0)))|0;
                    dstB = (dstB * (1-(srcA/255.0)))|0;
                    var pixel = (0xff << 24) | ((srcR + dstR)<<16) | ((srcG + dstG)<<8) | (srcB+dstB);
                    pixelData[x+(y*canvasWidth)] = pixel;
                }
                ix++;
            }
            iy++;
        }
    }
    else if(renderModeF == 1)
    {
        var iy = 0;
        for (var y = ypos; y < ypos+foreH; ++y) 
        {
            var ix = 0;
            for (var x = xpos; x < xpos+foreW; ++x) 
            {
                if(x>=0 && x < canvasWidth && y >=0 && y < canvasHeight)
                {
                    var pixelR = (srcDataF[ix+(iy*foreW)] >> 16) & 0xff;
                    var pixelG = (srcDataF[ix+(iy*foreW)] >> 8) & 0xff;
                    var pixelB = (srcDataF[ix+(iy*foreW)] >> 0) & 0xff;
                    var pixelRGB565 = RGB888toRGB565({ r: pixelR, g: pixelG, b: pixelB } );
                    var pixelRGB888 = RGB565toRGB888(pixelRGB565);
                    pixelData[x+(y*canvasWidth)] = (0xff << 24) | (pixelRGB888.r << 16) | (pixelRGB888.g << 8) | pixelRGB888.b;
                }
                ix++;
            }
            iy++;
        }
    }
    else if(renderModeF == 2)
    {
        var iy = 0;
        for (var y = ypos; y < ypos+foreH; ++y) 
        {
            var ix = 0;
            for (var x = xpos; x < xpos+foreW; ++x) 
            {
                if(x>=0 && x < canvasWidth && y >=0 && y < canvasHeight)
                {
                    var pixelA = (srcDataF[ix+(iy*foreW)] >> 24) & 0xff;
                    var pixelR = (srcDataF[ix+(iy*foreW)] >> 16) & 0xff;
                    var pixelG = (srcDataF[ix+(iy*foreW)] >> 8) & 0xff;
                    var pixelB = (srcDataF[ix+(iy*foreW)] >> 0) & 0xff;
                    var pixelRGB555 = RGB888toRGB555({ r: pixelR, g: pixelG, b: pixelB } );
                    var pixelRGB888 = RGB555toRGB888(pixelRGB555);
                    if(pixelA > 128)
                        pixelData[x+(y*canvasWidth)] = (0xff << 24) | (pixelRGB888.r << 16) | (pixelRGB888.g << 8) | pixelRGB888.b;
                }
                ix++;
            }
            iy++;
        }
    }
    else if(renderModeF == 3)
    {
        var iy = 0;
        for (var y = ypos; y < ypos+foreH; ++y) 
        {
            var ix = 0;
            for (var x = xpos; x < xpos+foreW; ++x) 
            {
                if(x>=0 && x < canvasWidth && y >=0 && y < canvasHeight)
                {
                    var pixelA = (srcDataF[ix+(iy*foreW)] >> 24) & 0xff;
                    var pixelR = (srcDataF[ix+(iy*foreW)] >> 16) & 0xff;
                    var pixelG = (srcDataF[ix+(iy*foreW)] >> 8) & 0xff;
                    var pixelB = (srcDataF[ix+(iy*foreW)] >> 0) & 0xff;
                    var pixelRGBA4444 = RGBA8888toRGBA4444({ r: pixelR, g: pixelG, b: pixelB, a: pixelA } );
                    var pixelRGBA8888 = RGBA4444toRGBA8888(pixelRGBA4444);
                    var srcA = pixelRGBA8888.a;
                    var srcR = pixelRGBA8888.r;
                    var srcG = pixelRGBA8888.g;
                    var srcB = pixelRGBA8888.b;
                    var dstR = (pixelData[x+(y*canvasWidth)] >> 16) & 0xff;
                    var dstG = (pixelData[x+(y*canvasWidth)] >> 8) & 0xff;
                    var dstB = (pixelData[x+(y*canvasWidth)] >> 0) & 0xff;
                    srcR = (srcR * (srcA/255.0))|0;
                    srcG = (srcG * (srcA/255.0))|0;
                    srcB = (srcB * (srcA/255.0))|0;
                    dstR = (dstR * (1-(srcA/255.0)))|0;
                    dstG = (dstG * (1-(srcA/255.0)))|0;
                    dstB = (dstB * (1-(srcA/255.0)))|0;
                    var pixel = (0xff << 24) | ((srcR + dstR)<<16) | ((srcG + dstG)<<8) | (srcB+dstB);
                    pixelData[x+(y*canvasWidth)] = pixel;
                }
                ix++;
            }
            iy++;
        }
    }

    imageData.data.set(buf8);
    ctx.putImageData(imageData, 0, 0);
    requestAnimationFrame(render);
}

//----------------------------------------------
// Background Rendering Mode 
//----------------------------------------------
function btnBClick(id)
{
    var lbl = document.getElementById("imageLabelb");
    switch(id)
    {
        case 1:
            lbl.innerText = "Background = 32bit ARGB";
            renderModeB = 0;
            break;
        case 2:
            lbl.innerText = "Background = 16bit RGB565";
            renderModeB = 1;
            break;
        case 3:
            lbl.innerText = "Background = 16bit RGB555-1";
            renderModeB = 2;
            break;
        case 4:
            lbl.innerText = "Background = 16bit RGBA4444";
            renderModeB = 3;
            break;            
    }
}

//----------------------------------------------
// Background Rendering Mode 
//----------------------------------------------
function btnFClick(id)
{
    var lbl = document.getElementById("imageLabelf");
    switch(id)
    {
        case 1:
            lbl.innerText = "Foreground = 32bit ARGB";
            renderModeF = 0;
            break;
        case 2:
            lbl.innerText = "Foreground = 16bit RGB565";
            renderModeF = 1;
            break;
        case 3:
            lbl.innerText = "Foreground = 16bit RGB555-1";
            renderModeF = 2;
            break;
        case 4:
            lbl.innerText = "Foreground = 16bit RGBA4444";
            renderModeF = 3;
            break;            
    }
}

//----------------------------------------------
// Background Image Load
//----------------------------------------------
function readSingleFileB(e)
{  
    var fr = new FileReader();
    fr.onload = function() {

        img = new Image();
        img.onload = function() {
            canvas.style.width = img.width;
            canvas.style.height = img.height;
            canvas.width = img.width;
            canvas.height = img.height;
            canvasWidth = img.width;
            canvasHeight = img.height;
            imageData = ctx.getImageData(0, 0, canvasWidth, canvasHeight);
            data = imageData.data;
            buf  = new ArrayBuffer(imageData.data.length);
            buf8 = new Uint8ClampedArray(buf);
            pixelData = new Uint32Array(buf);

            ctx.drawImage(img,0,0,canvasWidth,canvasHeight);
            var data = ctx.getImageData(0, 0, canvasWidth, canvasHeight);
            for (var y = 0; y < canvasHeight; ++y) 
            {
                for (var x = 0; x < canvasWidth; ++x) 
                {
                    var ofs = (x+(y*canvasWidth))*4;
                    var pixelR = data.data[ofs+0];
                    var pixelG = data.data[ofs+1];
                    var pixelB = data.data[ofs+2];
                    var pixelA = data.data[ofs+3];
                    srcDataB[x+(y*canvasWidth)] = (pixelA << 24) | (pixelB << 16) | (pixelG << 8) | pixelR;
                }
            }
        }
        img.src = fr.result;

    }
    fr.readAsDataURL(e.target.files[0]); 
}

//----------------------------------------------
// Foreground Image Load
//----------------------------------------------
function readSingleFileF(e)
{  
    var fr = new FileReader();
    fr.onload = function() {

        img = new Image();
        img.onload = function() {
            foreW = img.width;
            foreH = img.height;
            ctx2.clearRect(0,0,foreW,foreH);
            ctx2.drawImage(img,0,0);
            var data = ctx2.getImageData(0, 0, canvasWidth, canvasHeight);
            for (var y = 0; y < img.height; ++y) 
            {
                for (var x = 0; x < img.width; ++x) 
                {
                    var ofs = (x+(y*canvasWidth))*4;
                    var pixelR = data.data[ofs+0];
                    var pixelG = data.data[ofs+1];
                    var pixelB = data.data[ofs+2];
                    var pixelA = data.data[ofs+3];
                    srcDataF[x+(y*foreW)] = (pixelA << 24) | (pixelB << 16) | (pixelG << 8) | pixelR;
                }
            }
        }
        img.src = fr.result;

    }
    fr.readAsDataURL(e.target.files[0]); 
}


function mouseHandler(e)
{
    e = e || window.event;

    var pageX = e.pageX;
    var pageY = e.pageY;

    // IE 8
    if (pageX === undefined) {
        pageX = e.clientX + document.body.scrollLeft + document.documentElement.scrollLeft;
        pageY = e.clientY + document.body.scrollTop + document.documentElement.scrollTop;
    }

    xpos = pageX - document.getElementById("myCanvas").getBoundingClientRect().left - (foreW>>1);
    ypos = pageY - document.getElementById("myCanvas").getBoundingClientRect().top - (foreH>>1);
}

</script>

</head>

<body leftmargin="0" topmargin="0" bgcolor="#0f0f0f" onload="init();">

    <center>

        <div style="margin-top:50px;color:#aaaaaa;">
            BACKGROUND&nbsp;&nbsp;
            <input type="file" id="file-inputb" />
            <button name="btn1b" onclick="btnBClick(1);">32bit(ARGB)</button>
            <button name="btn2b" onclick="btnBClick(2);">16bit(RGB565)</button>
            <button name="btn3b" onclick="btnBClick(3);">16bit(RGB555-1)</button>
            <button name="btn4b" onclick="btnBClick(4);">16bit(ARGB4444)</button>
        </div>

        <div style="margin-top:50px;color:#aaaaaa;">
            FOREGROUND&nbsp;&nbsp;
            <input type="file" id="file-inputf" />
            <button name="btn1f" onclick="btnFClick(1);">32bit(ARGB)</button>
            <button name="btn2f" onclick="btnFClick(2);">16bit(RGB565)</button>
            <button name="btn3f" onclick="btnFClick(3);">16bit(RGB555-1)</button>
            <button name="btn4f" onclick="btnFClick(4);">16bit(ARGB4444)</button>
        </div>
    
        <div style="color:#ffffff;padding-bottom:50px;">
            <div id="imageLabelb" style="padding-top:50px;">32bit(ARGB)</div>
            <div id="imageLabelf" style="padding-top:50px;">32bit(ARGB)</div>
            <canvas id="myCanvas" width="960" height="540" style="border: 1px solid;" onmousemove="mouseHandler();"></canvas>
        </div>

    </center>

    <canvas id="loadCanvas" width="960" height="540" style="display:none;"></canvas>

</body>
</html>
